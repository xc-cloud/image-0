<!DOCTYPE html>
<html lang="cn" id="html" ng-app="plan" ng-controller="plan" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="//www.sangyuancheng.com/image/image/icon.png" type="image/svg+xml" >
    <title>计划</title>
    <meta name="description" content="随心笔录，分享">
    <link rel="stylesheet"  href="//www.sangyuancheng.com/image/css/bootstrap.min.css">
    <link rel="stylesheet"  href="//www.sangyuancheng.com/image/css/top.css">
    <link rel="stylesheet"  href="//www.sangyuancheng.com/image/css/type.css">
    <link rel="stylesheet"  href="//www.sangyuancheng.com/image/css/bottom.css">
    <script  src="//www.sangyuancheng.com/image/js/jquery.min.js"></script>
    <script th:remove src="//www.sangyuancheng.com/image/js/angular.min.js"></script>
    <script th:remove src="//www.sangyuancheng.com/image/js/bootstrap.min.js"></script>
    <script th:remove src="//www.sangyuancheng.com/image/js/base.js"></script>
    <script th:remove src="//www.sangyuancheng.com/image/js/date.js"></script>
    <script th:remove src="//www.sangyuancheng.com/image/js/modal.min.js"></script>
    <script src="//www.sangyuancheng.com/image/js/currentConfig.js"></script>  
    <style>
      body,#core, #card{
        overflow: hidden;
      }
        #core{
          width: 100%;
          padding-top: 15px;
          margin: auto;
          height: 40%;
          bottom: 0;
          position: fixed;
          background-image: url(http://5b0988e595225.cdn.sohucs.com/images/20200325/3fadec9974ab42578b76e5d238fb46f6.jpeg);
          background-repeat: no-repeat;
          background-size: cover;
        }
        #loadding{
          text-align: center;
          position: fixed;
          height: 60%;
          width: 100%;
          border: 0px;
          background-image: url(http://5b0988e595225.cdn.sohucs.com/images/20200325/e76e2f6f4385458e9098673411e2fb8c.jpeg);
          background-repeat: no-repeat;
          background-size: cover;
        }
        #loadding .load{
          color: rgb(255, 255, 255);
          width: 130px;
          height: 130px;
          font-size: 24px;
          line-height: 130px;
          border-radius: 50%;
          margin: auto;
        }
        #card,#cardInfo{
          position: fixed;
          z-index: 9;
          padding: 15px;
          height: 60%;
          width: 100%;
          bottom: -60%;
          transition: bottom .3s;
          background-image: url(http://5b0988e595225.cdn.sohucs.com/images/20200325/3fadec9974ab42578b76e5d238fb46f6.jpeg);
          background-repeat: no-repeat;
          background-size: cover;
        }
        #bottom{
          display: none !important;
        }
    </style>
</head>
<body id="scope">
  <div style="display: none;" ng-include="'//www.sangyuancheng.com/image/html/top.html'"></div>
  <div style="display: none;" ng-include="'//www.sangyuancheng.com/image/html/banner.html'"></div>
  <div id="loadding" onclick="$('#card,#cardInfo').css('bottom','-60%');$('.openCard').show()">
    <div ng-class="'load ' + loadding.class"  ng-bind="(100 -loadding.width).toFixed(2) + '%'"></div>
    <audio id="backgroundMusic" autoplay="autoplay" style="display: none;"></audio>
  </div>
  <div id="core">
    <div style="width: 80%;margin: auto;">
      <div>
          <div class="progress" style="margin: 0;height: 10px;">
            <div ng-class="'progress-bar ' + loadding.class" role="progressbar" style="width: {{loadding.width}}%;height:10px">
            </div>
          </div>
      </div>
      <div style="display: flex;justify-items: center;align-items: center;margin-top: 15px;">
        <p style="width: 33.33333%;font-size: 16px;color:green;text-align: left;" ng-bind="config.end"></p>
        <p style="width: 33.33333%;font-size: 16px;color:rgb(0, 174, 255);text-align: center;" ng-bind="config.this"></p>
        <p style="width: 33.33333%;font-size: 16px;color:red;text-align: right;" ng-bind="config.start"></p>
      </div>
    </div>
    <span ng-show="config.this > config.end && !body.isOpenCard" class="btn btn-sm btn-success openCard" onclick="$('#card').css('bottom','0');" style="display: block;width: 50%;margin: auto;margin-top: 10%;">立即打卡</span>
    <span ng-show="!(config.this > config.end)" style="display: block;text-align: center;color: rgb(0, 196, 0);margin: auto;margin-top: 10%;">已完成打卡任务</span>
    <span ng-show="body.isOpenCard" style="display: block;text-align: center;color: rgb(0, 196, 0);margin: auto;margin-top: 10%;">今天已完成打卡</span>
    <div style="margin-top: 15px;height: 120px;overflow-y: auto;background-color: rgba(255, 255, 255, 0.541);">
      <ul style="padding: 0;">
        <li ng-repeat="obj in body.list | orderBy:'order':true" ng-click="showMsg(obj)" style="text-align: right;height: 30px;line-height: 30px;padding-right: 15px;">
          <span>你在</span>
          <span ng-bind="formatDate(obj.time)" style="color: rgb(0, 196, 0);"></span>
          <span>完成</span>
          <span ng-bind="obj.num" style="color: rgb(255, 85, 6);"></span>
          <span>kg 打卡</span>
        </li>
      </ul>
    </div>
  </div>
  <div id="card">
      <div class="body">
        <h3 style="text-align: center;color: rgb(0, 196, 0);">立即打卡</h3>
        <div style="text-align: center;color: rgb(196, 160, 0);">
          <span>上一次打卡为</span>
          <span ng-bind="config.this"></span>
          <span>kg</span>
        </div>
        <div class="input-group" style="margin-top: 15px;">
          <span class="input-group-addon" style="color:#fff;background-color: rgba(5, 133, 33, 0.7);border-color:rgb(5, 133, 33)">最新的数值</span>
          <input type="number" ng-model="config.newThis" style="background-color:rgb(235, 253, 255);border-color:rgb(5, 133, 33)" class="form-control">
        </div>
        <div class="input-group" style="margin-top: 15px;display: flex;">
          <span class="input-group-addon" style="display: block;color:#fff;background-color: rgba(5, 133, 33, 0.7);border-color:rgb(5, 133, 33);width: 30%;">相对于之前</span>
          <span class="input-group-addon" style="display: block;width: 70%;color:{{config.msgColor}};background-color: rgba(255,255,255,0.33);border-color:rgb(5, 133, 33)" ng-bind="getMsg()"></span>
        </div>
        <div style="margin-top: 15px;">
          <textarea  ng-model="config.comment" style="background-color:rgb(235, 253, 255);border-color:rgb(5, 133, 33);resize: none;width: 100%;display: block;height: 150px;overflow-y: auto;" class="form-control" placeholder="记录下运动过程"></textarea>
        </div>
        <div style="text-align: center;margin-top: 15px;">
          <span class="btn btn-sm btn-warning" ng-click="sendCard()">打卡</span>
        </div>
        <div style="color: rgb(185, 57, 57);text-align: center;margin-top: 15px;">每天只能打卡一次哦！</div>
      </div>
  </div>
  <div id="cardInfo">
    <div class="body">
      <h3 style="text-align: center;color: rgb(0, 196, 0);">
      <span>打卡记录</span>
      </h3>
      <table class="table table-success table-bordered table-hover table-bg">
          <tbody>
            <tr>
              <td style="border-color: #fff;text-align: right;"><span>打卡时间：</span></td>
              <td style="border-color: #fff;"><span ng-bind="formatDate(thisConfig.time)" style="color: rgb(14, 99, 179);"></span></td>
            </tr>
            <tr>
              <td style="border-color: #fff;text-align: right;"><span>打卡数值：</span></td>
              <td style="border-color: #fff;color:rgb(210, 33, 216);"><span ng-bind="thisConfig.num"></span>
                <span>kg</span></td>
            </tr>
            <tr>
              <td style="border-color: #fff;text-align: right;"><span>相对于之前：</span></td>
              <td style="border-color: #fff;"><span style="color:{{thisConfig.msgColor}}" ng-bind="getMsgInfo(thisConfig.OldNum,thisConfig.num)"></span></td>
            </tr>
          </tbody>
      </table>
      <div style="padding: 5px;background-color:rgba(255, 255, 255, 0.356);">
        <div ng-bind="thisConfig.comment" style="width: 100%;min-height: 100px;max-height: 150px;overflow-y: auto;"></div>
      </div>
    </div>
</div>
  <div ng-include="'//www.sangyuancheng.com/image/html/bottom.html'"></div>
</body>
<script>
var id = "plan"
var  module = angular.module(id, [])
module.config(function($sceProvider) {$sceProvider.enabled(false)})

module.controller(id,function($scope,$sce){
    var current = new currentConfig()
    $scope.classNames = ["progress-bar-success","progress-bar-info","progress-bar-warning","progress-bar-danger"]
    $scope.config = {start:60.6,end:45,this:60.6,newThis:60.6,comment:"",type:0,msgColor:"rgb(255,141,0)"}
    $scope.thisConfig = {}
    //已完成百分比
    // 已完成 / 总数
    var w = (1 - (($scope.config.start - $scope.config.this) / ($scope.config.start - $scope.config.end)))*100
    $scope.body = {
      list : [],
      isOpenCard : false
    }
    $scope.loadding = {
      width:w,
      class:$scope.classNames[w > 80 ? 3 : w > 50 ? 2 : w > 30 ? 1 : 0]
    }
    $scope.showMsg = function(obj){
      console.log(obj)
      $scope.thisConfig = obj
      $('#cardInfo').css('bottom','0%');
    }
    $scope.getMsg = function(){
      var sum = ($scope.config.this - $scope.config.newThis).toFixed(1)
      if (sum > 0) {
        //减少了
        $scope.config.msgColor = "rgb(5, 133, 33)"
        return "减少了"+sum+"kg"
      } else if(sum < 0){
        //增加了
        $scope.config.msgColor = "red"
        return "增加了"+(sum*-1)+"kg"
      } else {
        //没有变化
        $scope.config.msgColor = "rgb(255,141,0)"
        return "没有变化"
      }
    }
    $scope.getMsgInfo = function(oldNum,num){
      if (num == null || oldNum == null){
        return ""
      }
      var sum = (oldNum - num).toFixed(1)
      if (sum > 0) {
        //减少了
        $scope.thisConfig.msgColor = "rgb(5, 133, 33)"
        return "减少了"+sum+"kg"
      } else if(sum < 0){
        //增加了
        $scope.thisConfig.msgColor = "red"
        return "增加了"+(sum*-1)+"kg"
      } else {
        //没有变化
        $scope.thisConfig.msgColor = "rgb(255,141,0)"
        return "没有变化"
      }
    }
    $scope.sendCard = function(){
      //拉取打卡记录，根据添加顺序进行降序，所以最后一条，为最新的打卡信息
      current.addOrUpdateConfig({
        "name":"plan_card_list",
        "value":JSON.stringify({
          "cardTime":new Date().getTime(),
          "this" : $scope.config.newThis,
          "comment":$scope.config.comment,
          "oldThis":$scope.config.this
        }),
        "order":$scope.body.list.length || 0,
        "type" : 700
      },function(e){
        if(e.code == 200) {
          modal.createModal(true,"打卡成功！")
          $('#card').css('bottom','-60%');
          $scope.init()
        } else {
          modal.createModal(false,"打卡失败！")
        }
      })
    }
    $scope.formatDate = function(time){
      return getDateObject(time).yyyyMMddHHmmssFormat
    }
    $scope.init = function (){
      //拉取打卡记录，根据添加顺序进行降序，所以最后一条，为最新的打卡信息
      $scope.body.list = []
      current.getConfig({
        "name":"plan_card_list"
      },function(e){
        if(e.code == 200) {
          for(var temp in e.data){
            var obj = JSON.parse(e.data[temp]["value"])
            $scope.body.list.push({
              time:obj.cardTime,
              num:obj.this,
              OldNum:obj.oldThis,
              comment:obj.comment,
              order:e.data[temp]["order"]
            })
          }
          if ($scope.body.list.length > 0){
            var item = $scope.body.list[$scope.body.list.length - 1]
            $scope.body.isOpenCard = getDateObject(item.time).yyyyMMddFormat == getDateObject().yyyyMMddFormat
            $scope.config.this = item.num
            $scope.config["newThis"] = $scope.config["this"]
            var w = (1 - (($scope.config.start - $scope.config.this) / ($scope.config.start - $scope.config.end)))*100
            $scope.loadding["width"] = w 
            $scope.loadding["class"] = $scope.classNames[w > 80 ? 3 : w > 50 ? 2 : w > 30 ? 1 : 0]
          }
          $scope.$applyAsync()
        }
      })
    }
    $scope.init()
})
// $.get("/music/songurl/m4a/0003JXVx2PhDxM",function(e){
//   $("#backgroundMusic").attr("src",e.data)
//   $("#backgroundMusic")[0].play()
// })

$("#loadding ").css("padding-top",($(window).height() * .7)/2 +"px")
</script>
</html>